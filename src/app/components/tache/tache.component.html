<!-- Arrière-plan flou + centrage du pop-up -->
<div class="modal-backdrop" *ngIf="tache">
  <!-- Fenêtre modale claire -->
  <div class="task-modal">
    <div class="close-btn" (click)="retour()">×</div>

    <div class="task-container">
      <div class="task-main">
        <div class="task-header">
          <h2>{{ tache.titreTache }}</h2>
          <span class="task-list">
            Dans la liste <strong>{{ tache.statut }}</strong>
          </span>
        </div>

        <div class="task-section">
          <h3>Membres</h3>
          <div *ngIf="tache.assigneA; else noMember">
            <div class="member-info">
              <div class="avatar">
                {{ getInitials(tache.assigneA) }}
              </div>
              <p>{{ tache.assigneA }}</p>
            </div>
          </div>
          <ng-template #noMember>
            <p>Aucun membre assigné</p>
          </ng-template>
        </div>

        <div class="task-section">
          <h3>Description</h3>
          <div *ngIf="!editingDescription">
            <p>{{ tache.descriptionTache || 'Ajouter une description détaillée...' }}</p>
            <button class="btn btn-primary" (click)="editDescription()">✏️ Modifier</button>
          </div>
          <div *ngIf="editingDescription">
            <textarea [(ngModel)]="tache.descriptionTache" rows="4" class="description-textarea"></textarea>
            <div class="action-buttons">
              <button class="btn btn-success" (click)="saveDescription()">💾 Sauvegarder</button>
              <button class="btn btn-danger" (click)="cancelEditDescription()">❌ Annuler</button>
            </div>
          </div>
        </div>

        <div class="task-section" *ngIf="tache.dateDebut || tache.dateFin">
          <h3>Dates</h3>
          <p *ngIf="tache.dateDebut">
            <strong>Début :</strong> {{ tache.dateDebut | date: 'longDate' }}
          </p>
          <p *ngIf="tache.dateFin">
            <strong>Fin :</strong> {{ tache.dateFin | date: 'longDate' }}
          </p>
        </div>
      </div>

      <div class="task-sidebar">
        <div>
          <h3>Ajouté à la carte</h3>
          <button class="sidebar-btn" (click)="toggleDatePicker($event)">📅 Dates</button>
          <button class="sidebar-btn">👤 Membres</button>
          <button class="sidebar-btn">🏷️ Étiquettes</button>
        </div>
        <div>
          <h3>Actions</h3>
          <button class="sidebar-btn" (click)="editDescription()">✏️ Modifier</button>
          <button class="sidebar-btn delete-btn" (click)="deleteTache()">🗑️ Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendrier -->
  <!-- non validation error msg -->
  <div *ngIf="dateErrorMessage" class="date-error-message">
    <div class="error-icon">⚠️</div>
    <div class="error-text">{{ dateErrorMessage }}</div>
  </div>
  <div class="date-picker-modal" *ngIf="showDatePicker">
    <div class="date-picker-overlay" (click)="toggleDatePicker()"></div>
    <div class="date-picker-container" #datePickerContainer>
      <div class="date-picker-header">
        <h3>Dates</h3>
        <button class="close-date-picker" (click)="toggleDatePicker()">×</button>
      </div>

      <div class="calendar-navigation">
        <button class="nav-btn start" (click)="moveCalendarYear(-1)">«</button>
        <button class="nav-btn" (click)="moveCalendarMonth(-1)">‹</button>
        <div class="current-month">{{ currentMonth | date:'MMMM yyyy':'':'fr' }}</div>
        <button class="nav-btn" (click)="moveCalendarMonth(1)">›</button>
        <button class="nav-btn end" (click)="moveCalendarYear(1)">»</button>
      </div>

      <div class="calendar">
        <div class="weekdays">
          <div class="weekday">Dim</div>
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mer</div>
          <div class="weekday">Jeu</div>
          <div class="weekday">Ven</div>
          <div class="weekday">Sam</div>
        </div>

        <div class="days">
          <div *ngFor="let day of calendarDays"
               class="day"
               [ngClass]="{
               'other-month': day.otherMonth,
               'selected': isSelectedDate(day.date),
               'today': isToday(day.date)
             }"
               (click)="selectDate(day.date)">
            {{ day.dayNumber }}
          </div>
        </div>
      </div>

      <div class="date-selection">
        <div class="date-field">
          <label for="startDate">
            <input type="checkbox" id="startDate" [(ngModel)]="hasStartDate" (change)="updateStartDate()">
            Date de début
          </label>
          <input type="date"
                 [disabled]="!hasStartDate"
                 [(ngModel)]="startDateValue"
                 (change)="updateTacheDates()">
        </div>

        <div class="date-field">
          <label for="dueDate">
            <input type="checkbox" id="dueDate" [(ngModel)]="hasDueDate" (change)="updateDueDate()">
            Date d'échéance
          </label>
          <div class="due-date-inputs">
            <input type="date"
                   [disabled]="!hasDueDate"
                   [(ngModel)]="dueDateValue"
                   (change)="updateTacheDates()">
            <input type="time"
                   [disabled]="!hasDueDate"
                   [(ngModel)]="dueTimeValue"
                   (change)="updateTacheDates()">
          </div>
        </div>
      </div>

      <div class="date-picker-actions">
        <button class="btn btn-success" (click)="saveDates()">Enregistrer</button>
        <button class="btn btn-danger" (click)="toggleDatePicker()">Annuler</button>
        <button *ngIf="hasStartDate || hasDueDate" class="btn btn-outline-danger" (click)="clearDates()">Supprimer</button>
      </div>
    </div>
  </div>
</div>
